# Feature Specification: 数据资产选择与展示

**Feature Branch**: `001-data-asset-select`
**Created**: 2026-01-22
**Status**: Draft
**Input**: User description: "在拖拽一个数据源到画布释放时，需要让用户能够选择具体的数据资产，并且在选定之后，当鼠标选择了画布上的这个数据源时，可以在右侧显示其具体的数据资产信息。以上用户的编排结果要包含在导出的json中。选择数据资产的过程：通过选择企业->选择数据资产->选择数据资产中的多个字段的过程确定最终数据资源。"

## Clarifications

### Session 2026-01-22

- Q: API 错误响应应如何分类处理？ → A: 智能分类：网络/超时错误重试；认证/权限/业务错误（401/403/404/400）不重试，显示具体错误信息
- Q: 数据资产信息应如何存储和缓存？ → A: 节点 data 存储完整信息（用于导出），同时使用内存缓存 Map 避免重复调用同一资产的详情接口
- Q: 单个数据资产的字段数量上限假设是多少？ → A: 大规模（最多 500 个字段），需要虚拟滚动和高效过滤
- Q: 加载 JSON 任务图时应如何重建资产缓存？ → A: 从 JSON 中的完整数据重建缓存，无需额外 API 调用
- Q: 可观测性（日志与监控）策略是什么？ → A: 实用级：记录关键操作（API 调用、配置、导出/导入）+ 错误，使用 console 级别控制
- Q: 目标浏览器兼容性要求是什么？ → A: 现代浏览器（Chrome >= 90, Edge >= 90, Firefox >= 88, Safari >= 14）
- Q: 用户在数据资产选择对话框中点击取消或关闭对话框时，节点应如何处理？ → A: 立即删除该节点，保持画布整洁
- Q: 当数据资产详情接口调用失败或网络超时时，系统应采用什么重试策略？ → A: 自动重试 2-3 次，失败后提示用户手动重试
- Q: 数据资产选择的三步骤（企业→资产→字段）应该采用哪种交互模式？ → A: 多步骤向导（上一步/下一步按钮，每步聚焦一个选择）
- Q: 网络请求应该在多长时间后判定为超时？ → A: 10 秒
- Q: 已配置数据资产的节点应该如何显示其已配置状态？ → A: 节点标题旁显示已选资产名称

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 拖放节点后选择数据资产 (Priority: P1)

用户从左侧面板拖拽数据源节点到画布释放后，需要立即通过一个友好的界面选择具体的数据资产。选择过程分为三个步骤：选择企业、选择该企业下的数据资产、选择数据资产中的字段。

**Why this priority**: 这是核心功能，没有这个功能，数据源节点只是空壳，无法进行后续的隐私计算编排。

**Independent Test**: 可以独立测试通过拖放节点→弹出选择对话框→完成选择→节点状态更新→查看右侧详情面板的完整流程。

**Acceptance Scenarios**:

1. **Given** 用户从左侧面板拖拽数据源节点到画布，**When** 用户在画布上释放节点，**Then** 系统自动弹出数据资产选择对话框
2. **Given** 数据资产选择对话框已弹出，**When** 用户选择企业，**Then** 系统显示该企业下的所有数据资产列表
3. **Given** 用户选择了数据资产，**When** 用户点击确认，**Then** 系统调用详情接口获取字段信息并显示字段选择界面
4. **Given** 字段选择界面已显示，**When** 用户选择一个或多个字段并确认，**Then** 数据源节点保存选择的数据资产信息，对话框关闭
5. **Given** 用户正在选择流程中，**When** 用户点击取消或关闭对话框，**Then** 该节点立即被删除，保持画布整洁

---

### User Story 2 - 查看已配置数据源的详情 (Priority: P1)

用户点击画布上已配置的数据源节点时，右侧面板显示该数据源所选数据资产的详细信息，包括资产基本信息和已选择的字段列表。

**Why this priority**: 这是核心功能，用户需要确认已配置的数据资产信息，并在编排过程中随时查看。

**Independent Test**: 可以独立测试点击已配置节点→右侧显示详情面板→验证信息完整性的流程。

**Acceptance Scenarios**:

1. **Given** 画布上存在已配置数据资产的数据源节点，**When** 用户点击该节点，**Then** 右侧面板显示数据资产详情
2. **Given** 数据资产详情已显示，**When** 详情面板已展示，**Then** 包含企业名称、资产名称、资产编号、资产描述等基本信息
3. **Given** 数据资产详情已显示，**When** 详情面板已展示，**Then** 包含已选择的字段列表（字段名、类型、长度、描述）
4. **Given** 用户点击未配置或已取消配置的节点，**When** 详情面板已展示，**Then** 显示"请先配置数据资产"的提示信息

---

### User Story 3 - 编辑已配置的数据资产 (Priority: P2)

用户可以重新配置已选择的数据资产，修改企业、数据资产或字段选择。

**Why this priority**: 提升用户体验，允许用户在编排过程中调整配置，无需删除重建节点。

**Independent Test**: 可以独立测试点击编辑按钮→弹出选择对话框→修改选择→验证更新的流程。

**Acceptance Scenarios**:

1. **Given** 画布上存在已配置的数据源节点，**When** 用户在右侧详情面板点击"重新配置"按钮，**Then** 系统弹出数据资产选择对话框并回显当前选择
2. **Given** 用户修改了数据资产选择，**When** 用户确认新选择，**Then** 节点和详情面板更新为新的数据资产信息
3. **Given** 用户在编辑过程中点击取消，**When** 修改未确认，**Then** 保持原有的数据资产配置不变

---

### User Story 4 - 导出包含数据资产信息的任务图 (Priority: P1)

用户完成隐私计算流程编排后，导出的 JSON 文件包含每个数据源节点所选数据资产的完整信息。

**Why this priority**: 这是核心功能，导出的任务图需要包含完整的编排信息，以便后续执行或加载。

**Independent Test**: 可以独立测试配置多个数据源→导出 JSON→验证导出文件中包含完整数据资产信息的流程。

**Acceptance Scenarios**:

1. **Given** 画布上存在已配置的数据源节点，**When** 用户点击导出按钮，**Then** 导出的 JSON 中每个数据源节点包含 assetId、assetName、enterpriseName、selectedFields 等信息
2. **Given** 导出的 JSON 文件，**When** 系统读取该文件，**Then** 能够根据文件中的信息恢复完整的任务图状态
3. **Given** 节点未配置数据资产，**When** 导出任务图，**Then** 导出的 JSON 中对应节点的数据资产相关字段为 null 或空

---

### User Story 5 - 搜索与过滤数据资产 (Priority: P2)

用户在选择数据资产时，可以通过搜索和过滤功能快速找到目标数据资产。

**Why this priority**: 提升用户体验，当数据资产数量较多时，搜索和过滤功能能显著提高配置效率。

**Independent Test**: 可以独立测试在对话框中输入搜索关键词→验证过滤结果的流程。

**Acceptance Scenarios**:

1. **Given** 数据资产选择对话框已显示企业列表，**When** 用户在企业搜索框输入关键词，**Then** 企业列表按企业名称过滤显示匹配结果
2. **Given** 用户选择了企业，**When** 用户在资产搜索框输入关键词，**Then** 数据资产列表按资产名称过滤显示匹配结果
3. **Given** 用户清空搜索框，**When** 搜索条件被移除，**Then** 显示完整的列表（所有企业或所有资产）
4. **Given** 字段选择界面已显示，**When** 字段数量较多（>50 个），**Then** 界面使用虚拟滚动确保性能
5. **Given** 字段选择界面已显示，**When** 用户在字段搜索框输入关键词，**Then** 字段列表按字段名过滤显示匹配结果

---

### Edge Cases

**空数据处理**:
- 当企业列表接口返回空列表时，显示"暂无可用企业"的提示，禁用"下一步"按钮
- 当所选企业下无数据资产时，显示"该企业暂无数据资产"的提示，禁用"下一步"按钮
- 当数据资产字段列表为空时，显示"该数据资产暂无可用字段"的提示，禁用"确认"按钮

**验证和错误处理**:
- 当用户未选择任何字段就点击确认时，提示"请至少选择一个字段"并阻止确认操作
- 当 API 返回认证错误（401）时，显示"登录已过期，请重新登录"提示并提供"重新登录"按钮，不进行重试
- 当 API 返回权限错误（403）时，显示"无权限访问该数据资产"提示并提供"重试"按钮，不进行重试
- 当 API 返回资源不存在（404）时，显示"数据资产不存在"提示并提供"重试"按钮，不进行重试
- 当 API 返回业务错误（400/501）时，显示后端返回的具体错误信息（msg 字段）并提供"重试"按钮，不进行重试
- 当网络请求超时（10 秒）时，系统自动重试 2-3 次，仍超时后显示"网络请求超时，请检查网络连接"提示并提供"重试"按钮
- 当发生网络错误（ERR_NETWORK）时，系统自动重试 2-3 次，仍失败后显示"网络连接失败，请检查网络设置"提示并提供"重试"按钮
- 当服务器错误（500/502/503）时，系统自动重试 2-3 次，仍失败后显示"服务器暂时不可用，请稍后重试"提示并提供"重试"按钮

**对话框交互**:
- 当用户在向导任意步骤点击取消时，对话框关闭，节点被删除（新建时）或保持原有配置不变（编辑时）
- 当用户按 ESC 键时，等同于点击取消操作
- 当用户点击对话框外部遮罩层时，等同于点击取消操作

**导出和导入**:
- 当导出时部分节点未配置数据资产，弹出警告"部分数据源节点未配置数据资产，仍要导出吗？"，用户确认后仍允许导出
- 当导入的 JSON 文件中节点数据损坏或缺失时，显示"导入失败：文件格式错误"提示
- 当导入的 JSON 文件中资产信息不完整时，将对应节点标记为未配置状态

**搜索和过滤**:
- 当搜索无结果时，显示"未找到匹配结果"提示
- 当用户在字段搜索框输入特殊字符时，系统应正常处理并执行过滤
- 当用户在字段搜索框输入超长字符串（>100 字符）时，显示"搜索关键词过长，请缩短后重试"提示

**并发和状态**:
- 当同一资产被多个节点选择时，后续节点从缓存中读取资产信息，无需额外 API 调用
- 当用户快速连续拖放多个节点时，每个节点独立弹出配置对话框
- 当用户在选择过程中修改浏览器标签页或刷新页面时，未配置的节点将被删除

**UI 交互**:
- 当拖放节点到画布边缘或无效位置时，节点应自动调整到有效位置
- 当用户在字段列表中快速滚动时，虚拟滚动应确保流畅渲染（帧率 > 30fps）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须在用户拖拽数据源节点到画布释放时自动弹出数据资产选择对话框
- **FR-002**: 系统必须在数据资产选择对话框中采用多步骤向导模式，支持上一步/下一步导航，每步聚焦一个选择（企业 → 资产 → 字段）
- **FR-002-1**: 系统必须在向导中显示当前步骤进度（如 "步骤 1/3: 选择企业"）
- **FR-002-2**: 系统必须在用户完成某步选择后才能进入下一步（未选择时"下一步"按钮置灰）
- **FR-002-3**: 系统必须允许用户通过"上一步"按钮返回修改之前的选择
- **FR-003**: 系统必须调用企业列表接口（asset/GetEnterpriseList）获取可用的企业列表
- **FR-004**: 系统必须支持根据企业名称搜索/过滤企业列表
- **FR-005**: 系统必须在用户选择企业后，显示该企业的所有数据资产（从企业列表接口返回的 enterpriseAssetList，或调用 GetAssetList 接口按 holderCompany 过滤获取）
- **FR-006**: 系统必须在用户选择数据资产后，调用数据资产详情接口（asset/GetAsset）获取完整的字段信息
- **FR-007**: 系统必须在字段选择界面显示字段列表，包括字段名、类型、长度、描述
- **FR-008**: 系统必须支持用户选择一个或多个字段
- **FR-009**: 系统必须在用户完成选择后，将数据资产信息保存到节点的 data.assetInfo 中
- **FR-010**: 系统必须在用户点击画布上的数据源节点时，在右侧面板显示数据资产详情
- **FR-011**: 系统必须在右侧详情面板中显示数据资产的基本信息（企业名称、资产名称、资产编号、描述、规模、周期等）
- **FR-012**: 系统必须在右侧详情面板中显示已选择的字段列表
- **FR-013**: 系统必须支持用户重新配置已选择的数据资产
- **FR-014**: 系统必须在导出任务图 JSON 时，包含每个数据源节点的完整数据资产信息（assetId、assetName、enterpriseName、selectedFields 等）
- **FR-015**: 系统必须支持加载包含数据资产信息的任务图 JSON 并恢复完整状态
- **FR-015-1**: 系统必须在加载 JSON 时从节点数据中提取完整资产信息并重建内存缓存，无需额外 API 调用
- **FR-016**: 系统必须在节点上清晰显示配置状态：已配置节点在标题旁显示已选资产名称，未配置节点显示"未配置"标签或特殊视觉标识
- **FR-017**: 系统必须采用智能错误分类处理策略：网络错误、超时错误自动重试 2-3 次；认证错误（401）、权限错误（403）、资源不存在（404）、业务错误（400）不重试，直接显示具体错误信息并提供重试按钮
- **FR-018**: 系统必须支持搜索和过滤企业列表及数据资产列表
- **FR-019**: 系统必须要求用户至少选择一个字段才能完成配置
- **FR-020**: 系统必须在用户取消配置时立即删除该节点，保持画布整洁
- **FR-021**: 系统必须在节点 data 中存储完整的数据资产信息（包括字段列表），以确保导出功能正常
- **FR-022**: 系统必须使用内存缓存（Map<assetId, AssetInfo>）避免重复调用同一资产的详情接口
- **FR-023**: 系统必须在字段选择界面支持虚拟滚动，以处理最多 500 个字段的列表
- **FR-024**: 系统必须在字段选择界面提供字段名称搜索功能，以快速定位目标字段
- **FR-025**: 系统必须记录关键操作的日志，包括 API 调用、配置完成、导出/导入操作
- **FR-026**: 系统必须使用 console 级别控制日志输出（error 用于错误，warn 用于警告，info 用于关键操作）
- **FR-027**: 系统必须在详情面板中按字段原始顺序显示已选字段列表（保持 API 返回的 itemList 顺序）
- **FR-028**: 系统必须在向导对话框中支持键盘快捷键：ESC 关闭对话框、Enter 确认当前步骤
- **FR-029**: 系统必须在详情面板空状态（未配置节点）时显示"请先配置数据资产"提示，并提供"配置"按钮
- **FR-030**: 系统必须在导入 JSON 时验证节点数据完整性，对于不完整的数据进行优雅降级处理

### Key Entities

**数据资产信息 (AssetInfo)**: 表示用户为数据源节点选择的具体数据资产，包含以下属性：
- assetId: 数据资产唯一标识
- assetNumber: 数据资产编号
- assetName: 数据资产名称
- assetEnName: 数据资产英文简称（可选）
- holderCompany: 资产所有者（企业名称）
- participantId: 平台 ID
- entityName: 实体名称
- intro: 资产描述（可选）
- scale: 数据规模（可选）
- cycle: 更新周期（可选）
- timeSpan: 时间跨度（可选）
- dataInfo: 数据集信息（包含 dbName、tableName、itemList 字段列表）

**已选字段 (SelectedField)**: 用户从数据资产中选择的具体字段（对应 API 中的 SaveTableColumnItem），包含：
- name: 字段名称
- dataType: 字段类型
- dataLength: 字段长度
- description: 字段描述
- isPrimaryKey: 是否主键（1=否，2=是）
- privacyQuery: 是否隐私查询（1=是，0=否）

**企业 (Enterprise)**: 数据资产的所属企业（对应 API 接口返回），包含：
- participantId: 平台 ID
- entityName: 实体名称
- enterpriseAssetList: 该企业的数据资产列表（EnterpriseAsset 简化信息）

**资产缓存 (AssetCache)**: 用于避免重复调用同一资产详情接口的内存缓存，结构为：
- 缓存类型：Map<assetId, AssetInfo>
- 生命周期：应用运行期间保持，页面刷新后清空
- 用途：多个节点选择同一资产时，优先从缓存读取，仅首次调用 API
- 缓存重建：加载 JSON 任务图时，从节点数据中提取完整资产信息重建缓存，无需额外 API 调用

## Success Criteria *(mandatory)*

### Measurable Outcomes

**性能指标**:
- **SC-001**: 在网络条件良好的情况下（API 响应 < 1 秒，宽带连接），用户可以在 30 秒内完成单个数据源节点的数据资产配置（从拖放到完成选择）
- **SC-005**: 当企业列表或数据资产数量超过 20 项时，搜索功能能够在 1 秒内返回过滤结果
- **SC-008**: 所有 API 请求超时阈值设置为 10 秒
- **SC-009**: 虚拟滚动在快速滚动时保持流畅，滚动帧率 > 30fps
- **SC-010**: 虚拟滚动处理 500 个字段时的内存占用 < 50MB

**可用性指标**:
- **SC-002**: 用户可以在右侧详情面板中清晰查看已配置数据资产的所有关键信息（企业名称、资产名称、资产编号、描述、规模、周期、字段列表）
- **SC-003**: 90% 的用户能够在首次使用时成功完成数据资产配置流程（成功标准：完成三步骤选择并保存配置）
- **SC-006**: 用户配置错误后重新配置的平均时间少于 15 秒（从点击"重新配置"到保存新配置）
- **SC-007**: 节点配置状态有清晰的视觉区分，用户识别准确率达到 100%（已配置显示资产名称，未配置显示"未配置"标签）

**数据完整性指标**:
- **SC-004**: 导出的任务图 JSON 包含 100% 完整的数据资产信息，可被系统正确加载和恢复
  - 验证标准：导出的 JSON 中每个已配置节点包含 assetId、assetName、enterpriseName、selectedFields、dataInfo 等完整信息
  - 恢复验证：导入 JSON 后，节点状态、资产详情、字段列表与导出时完全一致

**兼容性指标**:
- **SC-011**: 系统在 Chrome >= 90、Edge >= 90、Firefox >= 88、Safari >= 14 上正常运行
- **SC-012**: 拖放功能在上述浏览器上功能一致，无兼容性问题

## Assumptions

### API 依赖假设
1. 企业列表接口、数据资产列表接口、数据资产详情接口均已实现并可正常调用
2. 所有 API 接口使用 POST 请求（除 GetEnterpriseList 使用 GET），参数格式参考 contracts/api-contract.md
3. API 接口返回的数据格式稳定，字段名称和类型不会频繁变更
4. Mock 数据与真实 API 响应格式保持一致，确保切换到真实 API 时无需修改代码

### 用户和环境假设
5. 用户已经通过身份认证，可以访问其权限范围内的企业和数据资产，认证 Token 有效期内
6. 用户使用的浏览器为现代浏览器（Chrome >= 90, Edge >= 90, Firefox >= 88, Safari >= 14），支持现代 JavaScript 和 CSS 特性
7. 用户具有基本的数据素养，理解数据资产和字段的概念
8. 用户网络环境稳定，支持 API 请求的正常响应

### 数据和业务假设
9. 数据资产的字段信息在配置过程中是静态的，不会发生并发修改
10. 每个数据源节点只能配置一个数据资产
11. 数据资产选择是一次性操作，选择后不会自动同步更新
12. 单个数据资产的字段数量不超过 500 个，系统使用虚拟滚动技术确保大量字段场景下的 UI 性能
13. 用户不会在配置过程中进行异常操作（如快速连续点击、刷新页面）

### 技术和架构假设
14. 导出的 JSON 主要用于存储和恢复编排状态，不包含执行时数据
15. 系统使用浏览器 console API 进行日志记录，支持 error/warn/info 三级日志控制
16. Vue Flow 库的拖放事件处理与现有项目兼容
17. 右侧详情面板组件可以扩展以支持数据资产信息展示

### 数据规模假设
18. 企业列表通常不超过 100 个企业
19. 单个企业的数据资产通常不超过 100 个
20. 单个资产的字段数量上限为 500 个

## Dependencies

1. **企业列表接口** (asset/GetEnterpriseList) - 获取企业和数据资产列表
2. **数据资产详情接口** (asset/GetAsset) - 获取数据资产完整信息和字段列表
3. **Vue Flow 库** - 节点和画布管理
4. **右侧详情面板组件** - 需要扩展以支持数据资产信息展示

## Out of Scope

1. 数据资产的创建、编辑或删除功能
2. 数据资产权限管理（假设用户已具有访问权限）
3. 数据资产的实时更新监控
4. 多语言支持（界面默认使用中文）
5. 批量配置多个数据源节点
6. 数据资产配置的版本历史和撤销功能
7. 字段之间的依赖关系验证（如主外键关系）

## Non-Functional Requirements

### 性能要求
- **NFR-001**: API 响应时间测试方法：在良好网络条件（宽带连接，延迟 < 50ms）下测量从发起请求到接收完整响应的时间
- **NFR-002**: 虚拟滚动性能测试方法：使用浏览器 Performance API 测量滚动帧率，在 500 个字段场景下快速滚动，确保平均帧率 > 30fps
- **NFR-003**: 虚拟滚动内存占用测试方法：使用浏览器 Memory API 测量 500 个字段场景下的堆内存占用，确保 < 50MB
- **NFR-004**: 搜索性能测试方法：在不同数据规模（20、50、100、500 项）下测量从输入完成到结果显示的时间
- **NFR-005**: 配置流程性能测试方法：测量从拖放节点到完成选择的总耗时，在网络条件良好（API 响应 < 1 秒）的情况下 < 30 秒

### 可用性要求
- **NFR-006**: 详情面板空状态必须显示清晰的引导提示："请先配置数据资产"，并提供"配置"按钮
- **NFR-007**: 已配置节点必须显示资产名称，位置在节点标题右侧，使用绿色标识（#52C41A）
- **NFR-008**: 未配置节点必须显示"未配置"标签，使用灰色标识（#8c8c8c）
- **NFR-009**: 对话框必须支持键盘操作：ESC 关闭、Enter 确认、方向键导航列表
- **NFR-010**: 错误提示必须明确指出问题原因并提供可行的解决方案

### 兼容性要求
- **NFR-011**: 浏览器兼容性测试矩阵：Chrome >= 90、Edge >= 90、Firefox >= 88、Safari >= 14
- **NFR-012**: 拖放功能必须在所有目标浏览器上功能一致
- **NFR-013**: 虚拟滚动必须在所有目标浏览器上性能一致

### 可测试性要求
- **NFR-014**: E2E 测试必须在无头模式下可靠运行
- **NFR-015**: E2E 测试支持多 worker 并发执行，测试数据之间相互隔离
- **NFR-016**: Mock 数据必须覆盖所有 API 响应场景：成功、失败（网络/超时/认证/权限/业务错误）、空数据、部分数据

### 安全要求
- **NFR-017**: API 请求必须在请求头中包含认证 Token
- **NFR-018**: 用户输入必须进行 XSS 防护处理（搜索关键词、用户输入字段）
- **NFR-019**: 导出的 JSON 文件不包含敏感信息（仅包含用户已选择的资产元数据）

### 可维护性要求
- **NFR-020**: 代码中无 any 类型，所有类型定义明确
- **NFR-021**: 组件遵循单一职责原则，每个组件功能明确
- **NFR-022**: API 服务与 Mock 实现分离，便于切换

### 可扩展性要求
- **NFR-023**: 资产缓存结构支持扩展，可以添加更多缓存策略（如 LRU、TTL）
- **NFR-024**: 对话框组件支持扩展，可以添加更多配置步骤
- **NFR-025**: 虚拟滚动组件支持复用，可以用于其他需要虚拟滚动的场景
